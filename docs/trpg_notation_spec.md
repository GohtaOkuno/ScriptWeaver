# ScriptWeaver TRPG記法仕様書

## 概要
このドキュメントは、ScriptWeaverが認識・変換するTRPGシナリオの記法ルールを厳密に定義します。

---

## 1. 見出し記法

### 1.1 Markdown形式見出し
```
# メインタイトル        → <h1>
## 章タイトル           → <h2>
### セクションタイトル   → <h3>
#### サブセクション     → <h4>
##### 詳細項目         → <h5>
###### 最小項目        → <h6>
```

### 1.2 番号付き見出し
```
1. 概要               → <h1>
2. 背景設定           → <h1>
2-1. 主要NPC          → <h2>
2-1-1. NPC詳細        → <h3>
```

**ルール:**
- 数字 + ピリオド + スペース（任意）+ タイトル
- ハイフン区切りで階層表現（最大3階層）
- スペースの有無は問わない

---

## 2. CoC6版専用記法

### 2.1 技能判定記法
```
【目星】              → 技能判定（基本）
【図書館-20】         → 修正値付き技能判定
【機械修理orコンピュータ】 → 複合技能判定
```

### 2.2 アイテム・文書記法
```
『古い日記』          → アイテム・文書
『Class：Red』       → 複雑な名称のアイテム
```

### 2.3 ダイス記法
```
1d6                 → 基本ダイス
2d10+3              → 修正値付きダイス
1d100-20            → マイナス修正
```

### 2.4 SAN減少記法
```
SANc1/1d4           → SAN減少（成功/失敗）
SANc0/1d6+1         → 修正値付きSAN減少
```

---

## 3. 構造要素

### 3.1 会話・台詞記法
```
「こんにちは」        → 会話文
NPCは「助けて」と叫んだ → 文中の会話
```

### 3.2 表記法
```
項目1 | 項目2 | 項目3
-----|------|------
内容1 | 内容2 | 内容3
内容4 | 内容5 | 内容6
```

**ルール:**
- パイプ（|）区切り
- ヘッダー行とセパレータ行（---）が必要
- セパレータ行がない場合は2行以上のパイプ行で判定

### 3.3 定義リスト記法
```
◆ 項目名：説明内容
◆ 別の項目：別の説明
```

### 3.4 箇条書き記法
```
・ 項目1
・ 項目2
・ 項目3
```

### 3.5 セクション区切り
```
===========================
---------------------------
```

---

## 4. NPCステータス記法

### 4.1 基本ステータス
```
NPC名 (STR 12 CON 14 SIZ 10 INT 15 POW 13 DEX 11 HP 12 MP 13)
```

### 4.2 技能情報
```
技能: 〈隠れる〉60 〈聞き耳〉70 〈説得〉80
```

### 4.3 装備情報
```
装備: ナイフ(1d4+DB) 拳銃(1d10)
```

### 4.4 攻撃手段
```
噛みつき 60% ダメージ1d6
爪 70% ダメージ1d4+1
```

---

## 5. 厳密な判定ルール

### 5.1 優先順位
1. SAN記法（ダイス表記を含むため最優先）
2. ダイス記法
3. 技能記法
4. アイテム記法
5. 会話文記法

### 5.2 エラー処理
- 不完全な記法は通常テキストとして処理
- 曖昧な場合は最も近い形式で判定
- ネストした記法は外側を優先

### 5.3 制約事項
- 見出しは行頭必須
- 表は連続した行でのみ認識
- NPCステータスは括弧内にSTR等の文字列必須

---

## 6. 拡張予定記法

### 6.1 判定結果分岐
```
【目星】成功: 手がかりを発見
【目星】失敗: 何も見つからない
```

### 6.2 条件付き記法
```
[KP情報] 秘匿情報です
[PC情報] プレイヤー向け情報
```

### 6.3 ランダム表
```
1d6振り: 
1-2: 結果A
3-4: 結果B  
5-6: 結果C
```

---

## 7. 仕様変更履歴

- v1.0: 基本記法の定義
- v1.1: NPCステータス記法の追加
- v1.2: エンコーディング対応

---

## 8. 実装ガイドライン

### 8.1 正規表現パターン
各記法の認識には以下の正規表現を使用：

```python
# 技能記法
SKILL_PATTERN = r'【([^】]+)】'

# アイテム記法  
ITEM_PATTERN = r'『([^』]+)』'

# ダイス記法
DICE_PATTERN = r'(\d+d\d+(?:[+\-]\d+)?)'

# SAN記法
SAN_PATTERN = r'(SANc?\d+/\d+(?:d\d+)?(?:[+\-]\d+)?)'
```

### 8.2 バリデーション
- 各記法は厳密なパターンマッチングで判定
- 曖昧な記法は警告を出力
- 未対応記法は将来拡張として記録